name: Build iOS App

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '6.5.3'
        host: 'mac'
        target: 'ios'
        arch: 'ios'
        modules: 'qtcharts qtnetworkauth'
        cache: true

    - name: Import Code Signing Certificate (Optional)
      env:
        APPLE_CERT: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
        APPLE_CERT_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        APPLE_PROFILE: ${{ secrets.APPLE_PROVISIONING_PROFILE_BASE64 }}
      run: |
        # Only proceed if certificate is provided
        if [ -n "$APPLE_CERT" ]; then
          echo "Setting up code signing..."

          # Create temporary keychain
          security create-keychain -p actions build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p actions build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          echo "$APPLE_CERT" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "$APPLE_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k actions build.keychain

          # Import provisioning profile if provided
          if [ -n "$APPLE_PROFILE" ]; then
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$APPLE_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
            echo "Provisioning profile imported"
          fi

          echo "Code signing configured"
        else
          echo "No certificate provided, will build unsigned"
        fi

    - name: Configure CMake for iOS
      env:
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: |
        mkdir build-ios
        cd build-ios

        # Configure with or without code signing
        if [ -n "$APPLE_TEAM_ID" ]; then
          echo "Configuring with code signing..."
          cmake .. \
            -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_XCODE_ATTRIBUTE_DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY="iPhone Developer"
        else
          echo "Configuring without code signing (build only)..."
          cmake .. \
            -G Xcode \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=13.0 \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY="" \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_REQUIRED=NO \
            -DCMAKE_XCODE_ATTRIBUTE_CODE_SIGNING_ALLOWED=NO
        fi

    - name: Build iOS App
      run: |
        cd build-ios
        cmake --build . --config Release

    - name: Create IPA
      run: |
        # Find the built app (location varies based on Xcode configuration)
        if [ -d "build-ios/kleiner-brauhelfer-app/Release-iphoneos/kleiner-brauhelfer-app.app" ]; then
          APP_PATH="build-ios/kleiner-brauhelfer-app/Release-iphoneos"
        elif [ -d "build-ios/Release-iphoneos/kleiner-brauhelfer-app.app" ]; then
          APP_PATH="build-ios/Release-iphoneos"
        else
          echo "Searching for .app bundle..."
          find build-ios -name "kleiner-brauhelfer-app.app" -type d
          APP_PATH=$(find build-ios -name "kleiner-brauhelfer-app.app" -type d | head -n 1 | xargs dirname)
        fi

        echo "Found app at: $APP_PATH"
        cd "$APP_PATH"
        mkdir Payload
        cp -r kleiner-brauhelfer-app.app Payload/
        zip -r kleiner-brauhelfer-app.ipa Payload

        # Move IPA to root for easier artifact upload
        mv kleiner-brauhelfer-app.ipa "$GITHUB_WORKSPACE/"

        # Show signing info
        echo "IPA created. Checking code signature..."
        codesign -dv Payload/kleiner-brauhelfer-app.app 2>&1 || echo "App is not signed (expected without secrets)"

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v4
      with:
        name: kleiner-brauhelfer-app-ios
        path: kleiner-brauhelfer-app.ipa
        retention-days: 30

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build-ios/**/*.log
        retention-days: 7
